{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - CRM UNAD{% endblock %}

{% block extra_css %}
<style>
    .customer-info-card {
        border-left: 4px solid #28a745;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .invoice-form-card {
        border-left: 4px solid #007bff;
    }
    
    .required-field {
        color: #dc3545;
    }
    
    .calculation-display {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
    }
    
    .final-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2e7d32;
    }
    
    .customer-avatar {
        width: 60px;
        height: 60px;
        background: #28a745;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{% url 'crm:invoice_list' %}">Facturas</a>
                        </li>
                        {% if not is_edit %}
                            <li class="breadcrumb-item">
                                <a href="{% url 'crm:invoice_search_customer' %}">Buscar Cliente</a>
                            </li>
                        {% endif %}
                        <li class="breadcrumb-item active">
                            {% if is_edit %}Editar Factura{% else %}Registrar Factura{% endif %}
                        </li>
                    </ol>
                </nav>
                <h2 class="mb-0">
                    <i class="fas fa-file-invoice me-2 text-primary"></i>
                    {% if is_edit %}
                        Editar Factura {{ invoice.invoice_campaign_invoice_number }}
                    {% else %}
                        Registrar Nueva Factura
                    {% endif %}
                </h2>
            </div>
            <div>
                <a href="{% url 'crm:invoice_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Volver
                </a>
            </div>
        </div>

        <div class="row">
            <!-- Información del Cliente -->
            <div class="col-lg-4 mb-4">
                <div class="card customer-info-card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user me-2"></i>Información del Cliente
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="customer-avatar me-3">
                                {{ customer.customer_first_name.0 }}{{ customer.customer_first_surname.0 }}
                            </div>
                            <div>
                                <h6 class="mb-1">
                                    {{ customer.customer_first_name }}
                                    {% if customer.customer_middle_name %}
                                        {{ customer.customer_middle_name }}
                                    {% endif %}
                                    {{ customer.customer_first_surname }}
                                    {% if customer.customer_second_surname %}
                                        {{ customer.customer_second_surname }}
                                    {% endif %}
                                </h6>
                                <small class="text-muted">
                                    {{ customer.customer_document_type.document_type_acronym }} 
                                    {{ customer.customer_document_number }}
                                </small>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="row">
                            <div class="col-12 mb-2">
                                <strong><i class="fas fa-phone text-success me-2"></i>Teléfono:</strong><br>
                                {{ customer.customer_cell_number }}
                            </div>
                            
                            {% if customer.customer_email %}
                            <div class="col-12 mb-2">
                                <strong><i class="fas fa-envelope text-info me-2"></i>Email:</strong><br>
                                {{ customer.customer_email }}
                            </div>
                            {% endif %}
                            
                            <div class="col-12 mb-2">
                                <strong><i class="fas fa-map-marker-alt text-danger me-2"></i>Ciudad:</strong><br>
                                {{ customer.customer_city.city_name }}
                            </div>
                            
                            {% if customer.customer_neighborhood %}
                            <div class="col-12 mb-2">
                                <strong><i class="fas fa-home text-secondary me-2"></i>Barrio:</strong><br>
                                {{ customer.customer_neighborhood }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <hr>
                        
                        <div class="text-center">
                            <a href="{% url 'crm:customer_detail' customer.customer_id %}" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-eye me-1"></i>Ver Perfil Completo
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario de Factura -->
            <div class="col-lg-8">
                <div class="card invoice-form-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-edit me-2"></i>
                            {% if is_edit %}Editar Datos de la Factura{% else %}Datos de la Factura{% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="post" class="needs-validation" novalidate>
                            {% csrf_token %}
                            
                            <!-- Campo oculto del cliente -->
                            {{ form.invoice_customer }}
                            
                            <div class="row">
                                <!-- Campaña -->
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.campaign.id_for_label }}" class="form-label">
                                        Campaña
                                        <span class="required-field">*</span>
                                    </label>
                                    {{ form.campaign }}
                                    {% if form.campaign.help_text %}
                                        <div class="form-text">{{ form.campaign.help_text }}</div>
                                    {% endif %}
                                    {% if form.campaign.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.campaign.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Número de Factura -->
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.invoice_number.id_for_label }}" class="form-label">
                                        Número de Factura
                                        <span class="required-field">*</span>
                                    </label>
                                    {{ form.invoice_number }}
                                    {% if form.invoice_number.help_text %}
                                        <div class="form-text">{{ form.invoice_number.help_text }}</div>
                                    {% endif %}
                                    {% if form.invoice_number.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.invoice_number.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <!-- Fecha y Hora de Compra -->
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.invoice_purchase_date.id_for_label }}" class="form-label">
                                        Fecha de Compra
                                        <span class="required-field">*</span>
                                    </label>
                                    {{ form.invoice_purchase_date }}
                                    {% if form.invoice_purchase_date.help_text %}
                                        <div class="form-text">{{ form.invoice_purchase_date.help_text }}</div>
                                    {% endif %}
                                    {% if form.invoice_purchase_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.invoice_purchase_date.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Método de Pago -->
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.invoice_payment_method.id_for_label }}" class="form-label">
                                        Método de Pago
                                    </label>
                                    {{ form.invoice_payment_method }}
                                    {% if form.invoice_payment_method.help_text %}
                                        <div class="form-text">{{ form.invoice_payment_method.help_text }}</div>
                                    {% endif %}
                                    {% if form.invoice_payment_method.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.invoice_payment_method.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <!-- Local Comercial -->
                                <div class="col-md-12 mb-3">
                                    <label for="{{ form.invoice_commercial_premise.id_for_label }}" class="form-label">
                                        Local Comercial
                                    </label>
                                    {{ form.invoice_commercial_premise }}
                                    {% if form.invoice_commercial_premise.help_text %}
                                        <div class="form-text">{{ form.invoice_commercial_premise.help_text }}</div>
                                    {% endif %}
                                    {% if form.invoice_commercial_premise.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.invoice_commercial_premise.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <!-- Valor Total -->
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.invoice_purchase_value.id_for_label }}" class="form-label">
                                        Valor de Compra
                                        <span class="required-field">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.invoice_purchase_value }}
                                    </div>
                                    {% if form.invoice_purchase_value.help_text %}
                                        <div class="form-text">{{ form.invoice_purchase_value.help_text }}</div>
                                    {% endif %}
                                    {% if form.invoice_purchase_value.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.invoice_purchase_value.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Valor de Descuento -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        Valor de Descuento
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="id_discount" value="0" min="0" step="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Cálculo Automático -->
                            <div class="calculation-display">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="mb-1">
                                            <i class="fas fa-calculator me-2"></i>Resumen de Valores
                                        </h6>
                                        <div class="row text-sm">
                                            <div class="col-6">
                                                <small>Valor Total: $<span id="display-total">0</span></small>
                                            </div>
                                            <div class="col-6">
                                                <small>Descuento: $<span id="display-discount">0</span></small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="final-value">
                                            $<span id="display-final">0</span>
                                        </div>
                                        <small class="text-muted">Valor Final</small>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-ticket-alt me-1"></i>
                                        Tickets a generar: <span id="display-tickets" class="fw-bold">0</span>
                                    </small>
                                </div>
                            </div>

                            <!-- Notas de Validación -->
                            <div class="mb-3">
                                <label class="form-label">
                                    Notas de Validación
                                </label>
                                <textarea class="form-control" rows="3" placeholder="Notas adicionales..."></textarea>
                            </div>

                            <!-- Errores del formulario -->
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {{ form.non_field_errors }}
                                </div>
                            {% endif %}

                            <!-- Botones -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="{% url 'crm:invoice_list' %}" class="btn btn-outline-secondary me-md-2">
                                    <i class="fas fa-times me-1"></i>Cancelar
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>
                                    {% if is_edit %}Actualizar Factura{% else %}Registrar Factura{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Función para calcular valores
    function calculateValues() {
        var total = parseFloat($('#id_invoice_purchase_value').val()) || 0;
        var discount = parseFloat($('#id_discount').val()) || 0;
        var finalValue = total - discount;
        
        // Actualizar displays
        $('#display-total').text(total.toLocaleString());
        $('#display-discount').text(discount.toLocaleString());
        $('#display-final').text(finalValue.toLocaleString());
        
        // Calcular tickets basado en la campaña seleccionada
        var campaignId = $('#id_campaign').val();
        if (campaignId && finalValue > 0) {
            // Hacer llamada AJAX para obtener datos de la campaña
            $.ajax({
                url: '/crm/api/campaigns/' + campaignId + '/data/',
                type: 'GET',
                success: function(data) {
                    var minPurchase = data.minimum_purchase_value || 50000;
                    var multiplier = data.ticket_multiplier || 1;
                    
                    // Calcular tickets basado en el valor final
                    var tickets = Math.floor(finalValue / minPurchase) * multiplier;
                    $('#display-tickets').text(tickets);
                },
                error: function() {
                    $('#display-tickets').text('Error al calcular');
                }
            });
        } else {
            $('#display-tickets').text('0');
        }
    }
    
    // Eventos para recalcular
    $('#id_invoice_purchase_value, #id_discount, #id_campaign').on('input change', calculateValues);
    
    // Calcular al cargar
    calculateValues();
    
    // Validación en tiempo real
    $('#id_invoice_purchase_value').on('input', function() {
        var value = parseFloat($(this).val()) || 0;
        if (value <= 0) {
            $(this).addClass('is-invalid');
        } else {
            $(this).removeClass('is-invalid').addClass('is-valid');
        }
    });
    
    $('#id_discount').on('input', function() {
        var discount = parseFloat($(this).val()) || 0;
        var total = parseFloat($('#id_invoice_purchase_value').val()) || 0;
        
        if (discount > total) {
            $(this).addClass('is-invalid');
        } else {
            $(this).removeClass('is-invalid').addClass('is-valid');
        }
    });
    
    // Establecer fecha y hora actual por defecto
    {% if not is_edit %}
        var now = new Date();
        var year = now.getFullYear();
        var month = String(now.getMonth() + 1).padStart(2, '0');
        var day = String(now.getDate()).padStart(2, '0');
        var hours = String(now.getHours()).padStart(2, '0');
        var minutes = String(now.getMinutes()).padStart(2, '0');
        
        var datetime = year + '-' + month + '-' + day;
        $('#id_invoice_purchase_date').val(datetime);
    {% endif %}
});
</script>
{% endblock %}