{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - CRM UNAD{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1><i class="fas fa-user me-2"></i>{{ page_title }}</h1>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'crm:customer_edit' customer.customer_id %}" class="btn btn-warning">
            <i class="fas fa-edit me-2"></i>Editar
        </a>
        <a href="{% url 'crm:customer_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Información Personal</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <strong>Nombre Completo:</strong><br>
                        {{ customer.customer_first_name }} 
                        {% if customer.customer_middle_name %}{{ customer.customer_middle_name }}{% endif %}
                        {{ customer.customer_first_surname }}
                        {% if customer.customer_second_surname %}{{ customer.customer_second_surname }}{% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <strong>Documento:</strong><br>
                        {{ customer.customer_document_number }}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <strong>Fecha de Nacimiento:</strong><br>
                        {{ customer.customer_date_birth|date:"d/m/Y" }}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <strong>Género:</strong><br>
                        {% if customer.customer_gender %}
                            {{ customer.customer_gender.gender_name }}
                        {% else %}
                            No especificado
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <strong>Correo Electrónico:</strong><br>
                        {% if customer.customer_email %}
                            <a href="mailto:{{ customer.customer_email }}">{{ customer.customer_email }}</a>
                        {% else %}
                            No registrado
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <strong>Celular:</strong><br>
                        {% if customer.customer_cell_number %}
                            <a href="tel:{{ customer.customer_cell_number }}">{{ customer.customer_cell_number }}</a>
                        {% else %}
                            No registrado
                        {% endif %}
                    </div>
                    
                    {% if customer.customer_landline_number %}
                    <div class="col-md-6 mb-3">
                        <strong>Teléfono Fijo:</strong><br>
                        <a href="tel:{{ customer.customer_landline_number }}">{{ customer.customer_landline_number }}</a>
                    </div>
                    {% endif %}
                    
                    {% if customer.customer_blood_type %}
                    <div class="col-md-6 mb-3">
                        <strong>Tipo de Sangre:</strong><br>
                        {{ customer.customer_blood_type.blood_type_name }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        {% if customer.customer_neighborhood %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Ubicación</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <strong>Barrio:</strong><br>
                        {{ customer.customer_neighborhood.neighborhood_name }}
                    </div>
                    
                    {% if customer.customer_neighborhood.neighborhood_populated_place %}
                    <div class="col-md-6 mb-3">
                        <strong>Localidad:</strong><br>
                        {{ customer.customer_neighborhood.neighborhood_populated_place.populated_place_name }}
                    </div>
                    
                    {% if customer.customer_neighborhood.neighborhood_populated_place.populated_place_city %}
                    <div class="col-md-6 mb-3">
                        <strong>Ciudad:</strong><br>
                        {{ customer.customer_neighborhood.neighborhood_populated_place.populated_place_city.city_name }}
                    </div>
                    
                    {% if customer.customer_neighborhood.neighborhood_populated_place.populated_place_city.city_department %}
                    <div class="col-md-6 mb-3">
                        <strong>Departamento:</strong><br>
                        {{ customer.customer_neighborhood.neighborhood_populated_place.populated_place_city.city_department.department_name }}
                    </div>
                    {% endif %}
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Estadísticas</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Puntos Acumulados:</strong><br>
                    <span class="badge bg-primary fs-6">{{ customer.customer_points }}</span>
                </div>
                
                <div class="mb-3">
                    <strong>Total Facturas:</strong><br>
                    <span class="badge bg-success fs-6">{{ customer.customer_invoices }}</span>
                </div>
                
                <div class="mb-3">
                    <strong>Total Compras:</strong><br>
                    <span class="badge bg-info fs-6">${{ customer.customer_purchases|floatformat:0 }}</span>
                </div>
                
                <div class="mb-3">
                    <strong>Fecha de Registro:</strong><br>
                    <small class="text-muted">{{ customer.customer_registration_date|date:"d/m/Y H:i" }}</small>
                </div>
                
                <div class="mb-3">
                    <strong>Última Actualización:</strong><br>
                    <small class="text-muted">{{ customer.customer_date_update|date:"d/m/Y H:i" }}</small>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-signature me-2"></i>Firma Electrónica
                </h5>
            </div>
            <div class="card-body">
                <div id="signatureContainer">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando firma...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Acciones Rápidas</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if customer.customer_email %}
                    <a href="mailto:{{ customer.customer_email }}" class="btn btn-outline-primary">
                        <i class="fas fa-envelope me-2"></i>Enviar Email
                    </a>
                    {% endif %}
                    
                    {% if customer.customer_cell_number %}
                    <a href="tel:{{ customer.customer_cell_number }}" class="btn btn-outline-success">
                        <i class="fas fa-phone me-2"></i>Llamar
                    </a>
                    {% endif %}
                    
                    <button class="btn btn-outline-info" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
// Cargar firma al inicializar la página
$(document).ready(function() {
    loadCustomerSignature({{ customer.customer_id }});
});

function loadCustomerSignature(customerId) {
    $.ajax({
        url: `/customers/${customerId}/signature/`,
        type: 'GET',
        success: function(response) {
            if (response.success && response.signature) {
                const signature = response.signature;
                const signatureHtml = `
                    <div class="text-center">
                        <img src="data:image/png;base64,${signature.imageData.replace('data:image/png;base64,', '')}" 
                             alt="Firma del cliente" 
                             class="img-fluid border rounded p-2" 
                             style="max-height: 150px; background-color: #f8f9fa;">
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Firma capturada el: ${new Date(signature.timestamp).toLocaleString()}
                            </small>
                        </div>
                        <div class="mt-2">
                            <a href="/customers/${customerId}/signature/image/" 
                               class="btn btn-sm btn-outline-primary" 
                               target="_blank">
                                <i class="fas fa-external-link-alt me-1"></i>Ver en pantalla completa
                            </a>
                        </div>
                    </div>
                `;
                $('#signatureContainer').html(signatureHtml);
            } else {
                $('#signatureContainer').html(`
                    <div class="text-center text-muted">
                        <i class="fas fa-signature fa-3x mb-3"></i>
                        <p>No hay firma registrada para este cliente</p>
                        <small>La firma se captura durante el proceso de registro del cliente</small>
                    </div>
                `);
            }
        },
        error: function() {
            $('#signatureContainer').html(`
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Error al cargar la firma</p>
                    <small>Inténtelo de nuevo más tarde</small>
                </div>
            `);
        }
    });
}
</script>

{% endblock %}